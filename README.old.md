# Dar — Malta AI Real Estate Concierge (PWA)

Dar is a production‑ready, mobile‑first PWA for Malta property discovery. It combines:
- A rich, Malta‑specific UI/UX (EPC, sea view, parking, outdoor space, finish level).
- Supabase for listings, feed sources, AI routing, and scheduling.
- Moltbot as the automated operator that searches, extracts, and updates listings hourly.
- SEO prerender for indexable listings, vendors, categories, and locations.

---

## Architecture

**Frontend (PWA)**
- Single‑page app in `index.html` with Malta‑specific filters and cards.
- Service worker `sw.js` for offline caching.
- Static SEO pages + sitemaps generated by `scripts/seo-generate.mjs`.

**Backend (Supabase)**
- Tables: `property_listings`, `property_feed_sources`, `moltbot_jobs`, `property_listing_reports`.
- Edge Functions:
  - `ai-router` — OpenAI/Gemini web search + response proxy.
  - `rss-sync` — discover RSS/Atom feeds and ingest listings.
  - `moltbot-jobs` — queue + manage Moltbot jobs.
  - `moltbot-ingest` — insert listings from Moltbot.
- Cron jobs in Supabase (hourly):
  - `rss-sync`
  - `moltbot-jobs` create

**Automation (Moltbot)**
- Runs hourly cron to:
  1) pull queued jobs
  2) run AI web search (Gemini → OpenAI fallback via Supabase)
  3) ingest listings into Supabase

---

## Repository Layout

```
.
├── index.html
├── sw.js
├── manifest.json
├── scripts/
│   └── seo-generate.mjs
├── supabase/
│   ├── functions/
│   │   ├── ai-router/
│   │   ├── rss-sync/
│   │   ├── moltbot-jobs/
│   │   └── moltbot-ingest/
│   └── migrations/
├── moltbot/
│   ├── README.md
│   └── skills/
│       └── dar-marketplace/
└── DEPLOY_CLOUDFLARE.md
```

---

## Local Preview

Any static server works:
```bash
cd /Users/jeanbosco/workspace/dar
# Example:
python3 -m http.server 3000
```

---

## Supabase Setup

**Project URL**
```
https://yxtpdgxaqoqsozhkysty.supabase.co
```

### Secrets (Supabase Dashboard → Functions → Secrets)
Required:
- `OPENAI_API_KEY`
- `GEMINI_API_KEY`
- `ANTHROPIC_API_KEY` (optional)
- `SUPABASE_SERVICE_ROLE_KEY`
- `MOLTBOT_JOB_TOKEN`
- `MOLTBOT_INGEST_TOKEN`

### Tables
- `property_listings`: listing data (ingested from feeds + Moltbot)
- `property_feed_sources`: URLs for marketplaces/agencies/hotels/groups
- `moltbot_jobs`: queue for Moltbot searches
- `property_listing_reports`: moderation reports

### Migrations
All migrations are in `supabase/migrations/`.

### Functions
Deploy:
```bash
supabase functions deploy ai-router rss-sync moltbot-jobs moltbot-ingest --use-api
```

### Scheduled Jobs (Supabase)
These are already set up in the DB:
- Hourly `rss-sync`
- Hourly `moltbot-jobs` enqueue

---

## Moltbot (Automation)

### 1) Install from source
```bash
git clone https://github.com/moltbot/moltbot.git
cd moltbot
pnpm install
pnpm ui:build
pnpm build
pnpm moltbot onboard --install-daemon
```

### 2) Configure gateway + disable external web tools
Moltbot must **not** use external search APIs. We route web search through Supabase.

`~/.moltbot/moltbot.json` (or `~/.clawdbot/moltbot.json`):
```json
{
  "agents": {
    "defaults": {
      "workspace": "/Users/jeanbosco/clawd"
    }
  },
  "gateway": {
    "mode": "local",
    "bind": "loopback",
    "auth": {
      "mode": "token",
      "token": "YOUR_GATEWAY_TOKEN"
    }
  },
  "tools": {
    "web": {
      "search": { "enabled": false },
      "fetch": { "enabled": false }
    }
  }
}
```

### 3) Install the Dar skill
```bash
mkdir -p ~/clawd/skills
cp -R moltbot/skills/dar-marketplace ~/clawd/skills/dar-marketplace
```

Create `~/clawd/skills/dar-marketplace/.env`:
```
DAR_SUPABASE_URL=https://yxtpdgxaqoqsozhkysty.supabase.co
DAR_MOLTBOT_JOB_TOKEN=...
DAR_MOLTBOT_INGEST_TOKEN=...
```

### 4) Add hourly cron
```bash
pnpm moltbot cron add \
  --name dar-marketplace \
  --cron "0 * * * *" \
  --session isolated \
  --message "Run the dar-marketplace skill: pull queued jobs, use dar-ai-search (Gemini with OpenAI fallback) via ai-router web search, ingest listings, mark jobs complete."
```

### 5) Manual test (optional)
```bash
cd ~/clawd/skills/dar-marketplace
node scripts/dar-ai-search.mjs --query "Sliema 2 bed sea view"
node scripts/dar-ingest.mjs listings.json
```

---

## AI Web Search (Gemini → OpenAI fallback)

`dar-ai-search.mjs` calls the Supabase `ai-router` function with `use_web_search=true`.
- Default provider: **Gemini**
- Fallback: **OpenAI**

Example:
```bash
node scripts/dar-ai-search.mjs --query "Gozo farmhouse rent"
```

Override:
```bash
node scripts/dar-ai-search.mjs --provider openai --query "Valletta penthouse"
```

---

## SEO / Prerender

Generate static SEO pages + sitemaps:
```bash
node scripts/seo-generate.mjs
```

Outputs:
- `/listing/{id}/index.html`
- `/vendors`, `/vendor/{slug}`
- `/categories/{slug}`, `/locations/{slug}`
- `sitemap.xml` + segmented sitemaps

Robots + headers:
- `robots.txt` allows public routes only.
- `_headers` applies `X-Robots-Tag` for private routes.

---

## Cloudflare Deployment

See `DEPLOY_CLOUDFLARE.md`.
Recommended:
- Build command: `node scripts/seo-generate.mjs`
- Output dir: `.`
  
---

## Security Notes

- Never commit Supabase service role key or DB password.
- Keep Moltbot gateway token private.
- Rotate any keys that were previously shared.

---

## Troubleshooting

**Gateway won’t start**
- Ensure `gateway.mode=local` is set.
- Ensure `gateway.auth.token` is set.
- Run:
```bash
pnpm moltbot gateway status
```

**Cron won’t add**
- Gateway must be running and reachable at `ws://127.0.0.1:18789`.

**No listings in UI**
- Check `property_listings` table.
- Run `rss-sync` or trigger a Moltbot job.

